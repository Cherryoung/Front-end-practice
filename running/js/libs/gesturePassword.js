(function(a,b){var d={ui:{createCanvas:function(e,f){return b("<canvas>您的浏览器不支持canvas</canvas>").attr("width",e).attr("height",f).show()}},util:{generalPointers:function(o,j,f){var m=o.canvasWidth-2*o.horizontalMargin,g=o.canvasHeight-2*o.verticalMargin,k=m/(o.horizontalPointerCount-1),i=g/(o.verticalPointerCount-1),l,n,e;for(n=0;n<o.verticalPointerCount;n++){for(l=0;l<o.horizontalPointerCount;l++){e={x:o.horizontalMargin+l*k,y:o.verticalMargin+n*i};j.push(e);f.push({x1:e.x-o.outerBallRadius,y1:e.y-o.outerBallRadius,x2:e.x+o.outerBallRadius,y2:e.y+o.outerBallRadius})}}},generalCanvas:function(o,q,h,f){var g=o[0];g.width=q.canvasWidth;g.height=q.canvasHeight;var p=g.getContext("2d"),e,n,m,k;for(n=0,k=h.length;n<k;n++){e=h[n];p.beginPath();p.arc(e.x,e.y,q.innerBallRadius,0,Math.PI*2,true);p.fillStyle=q.pointerColor;p.fill();p.beginPath();p.arc(e.x,e.y,q.outerBallRadius,0,Math.PI*2,true);p.lineWidth=2;p.strokeStyle=q.pointerColor;p.stroke()}},getMousePage:function(g,f,e){return{x:f-g.offset().left,y:e-g.offset().top}},clearRect:function(g){var f=g[0],e=f.getContext("2d");e.clearRect(0,0,f.width,f.height)},drawPointer:function(f,h,e,g){f.beginPath();f.arc(h.x,h.y,e,0,Math.PI*2,true);f.fillStyle=g;f.closePath();f.fill()},drawLine:function(g,i,f,e,h){g.lineWidth=e;g.strokeStyle=h;g.beginPath();g.moveTo(i.x,i.y);g.lineTo(f.x,f.y);g.stroke();g.closePath()},locateCircular:function(g,e,f){var h=Math.sqrt(Math.abs(Math.pow(g.x-e.x,2))+Math.abs(Math.pow(g.y-e.y,2)));return h<f},locateBound:function(j,f){var g,e,h;for(g=0,e=f.length;g<e;g++){h=f[g];if(j.x>h.x1&&j.x<h.x2&&j.y>h.y1&&j.y<h.y2){return g}}return -1}}},c=function(){var i=this,n,l,o,f={LENGTH_TOO_SMALL:1},h=[],e=[],m=[],g=[],j=function(){var p=false,q;l.on("mousedown",function(s){var t=d.util.getMousePage(l,s.pageX,s.pageY),r=d.util.locateBound(t,e);if(r!==-1&&d.util.locateCircular(t,h[r],n.setting.outerBallRadius)===true){p=true;n.clear();n.selectPointer(r);q=h[r];n.draw(null,null)}});l.on("mousemove",function(s){if(p===true){var t=d.util.getMousePage(l,s.pageX,s.pageY),r=d.util.locateBound(t,e);if(r!==-1&&d.util.locateCircular(t,h[r],n.setting.outerBallRadius)===true&&d.util.locateCircular(t,q,n.setting.outerBallRadius)!==true&&m.length<=n.setting.maxLength){n.selectPointer(r);q=h[r];n.draw(null,null)}else{n.draw(t,null)}}});l.on("mouseup",function(){p=false;if(n.setting.minLength>m.length){n.draw(null,n.setting.errorLineColor);if(b.isFunction(n.setting.callback.onerror)){n.setting.callback.onerror(f.LENGTH_TOO_SMALL,"密码长度至少三位数")}}else{n.draw(null,null)}})},k=function(p,q){n=this;n.setting=b.extend(true,{},b.canvas.gesturePassword.defaults,n.setting,q);l=d.ui.createCanvas(n.setting.canvasWidth,n.setting.canvasHeight);o=l[0].getContext("2d");j();d.util.generalPointers({canvasWidth:n.setting.canvasWidth,canvasHeight:n.setting.canvasHeight,innerBallRadius:n.setting.innerBallRadius,outerBallRadius:n.setting.outerBallRadius,horizontalMargin:n.setting.horizontalMargin,verticalMargin:n.setting.verticalMargin,horizontalPointerCount:n.setting.horizontalPointerCount,verticalPointerCount:n.setting.verticalPointerCount},h,e);n.draw(null,null);p.append(l);return n};return b.extend(true,k,{prototype:{setting:{},draw:function(w,u){var t={canvasWidth:n.setting.canvasWidth,canvasHeight:n.setting.canvasHeight,innerBallRadius:n.setting.innerBallRadius,outerBallRadius:n.setting.outerBallRadius,pointerColor:n.setting.pointerColor,horizontalMargin:n.setting.horizontalMargin,verticalMargin:n.setting.verticalMargin},r,q,v,p;d.util.clearRect(l);d.util.generalCanvas(l,t,h,e);o.lineWidth=n.setting.lineWidth;o.strokeStyle=n.setting.strokeStyle;u=u||n.setting.lineColor;if((q=m.length)===1){d.util.drawPointer(o,m[0],n.setting.selectedPointerRadius,u);p=m[0]}else{if(q>1){for(r=0;r<q-1;r++){v=m[r];p=m[r+1];d.util.drawPointer(o,v,n.setting.selectedPointerRadius,u);d.util.drawLine(o,v,p,n.setting.lineWidth,u)}d.util.drawPointer(o,p,n.setting.selectedPointerRadius,u)}}if(w){d.util.drawLine(o,p,w,n.setting.lineWidth,u)}},clear:function(){d.util.clearRect(l);g.splice(0,g.length);m.splice(0,m.length);g=[];m=[];n.draw(null)},selectPointer:function(p){g.push(p);m.push(h[p])},error:function(p,q){n.draw(null,n.setting.errorLineColor);if(b.isFunction(n.setting.callback.onerror)){n.setting.callback.onerror(p,q)}},getData:function(){alert(g.join(","));return g.join(",")}}})}();b.extend(true,b,{canvas:{gesturePassword:{get:function(e,g){var f=e.data("canvas-gesturePassword");if(!f){f=new c(e,g);e.data("canvas-gesturePassword",f)}return f},defaults:{canvasWidth:400,canvasHeight:400,innerBallRadius:10,outerBallRadius:30,horizontalMargin:100,verticalMargin:100,horizontalPointerCount:3,verticalPointerCount:3,selectedPointerRadius:20,lineWidth:25,lineColor:"#CCC",errorLineColor:"red",pointerColor:"RGB(45, 134, 231)",repeat:true,minLength:3,maxLength:12,callback:{onerror:function(e,f){alert(f)}}}}}})}(window,jQuery));